# --------------------------------------------------------------------------------------------
# ğŸ“„ pipeline_inseguro.yml â€” Ejemplo de pipeline CI/CD con malas prÃ¡cticas intencionales.
# --------------------------------------------------------------------------------------------

# ğŸ“Œ Nombre del workflow mostrado en GitHub Actions.
name: CI/CD Inseguro

# ğŸ“Œ Evento que dispara el pipeline:
# âŒ MALA PRÃCTICA: Se ejecuta directamente en cada push a la rama main,
# sin revisiones de PR ni revisiones manuales.
on:
  push:
    branches:
      - main

# --------------------------------------------------------------------------------------------
# ğŸ“Œ DefiniciÃ³n de los jobs que se ejecutan en este pipeline.
jobs:
  build-and-deploy:
    # ğŸ“Œ Ambiente de ejecuciÃ³n: mÃ¡quina virtual Ubuntu.
    runs-on: ubuntu-latest

    # ----------------------------------------------------------------------------------------
    # âŒ MALA PRÃCTICA: Variables de entorno con secretos hardcodeados dentro del archivo YAML.
    # Esto expone credenciales sensibles (cadena de conexiÃ³n de base de datos y contraseÃ±a de Docker Hub).
    env:
      CONNECTION_STRING: "Server=myserver;Database=mydb;User Id=admin;Password=SuperSecret123;"
      DOCKER_PASSWORD: "dockerhubplaintextpassword"

    steps:
    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 1: Obtener el cÃ³digo fuente desde el repositorio.
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 2: Restaurar dependencias de NuGet.
    - name: Restaurar dependencias
      run: dotnet restore

    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 3: Compilar el proyecto en modo Release.
    - name: Compilar proyecto
      run: dotnet build --configuration Release

    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 4: Publicar el artefacto compilado.
    # âŒ MALA PRÃCTICA: No se realiza firma de artefactos ni validaciÃ³n de integridad.
    - name: Publicar artefacto
      run: dotnet publish --configuration Release --output ./publish

    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 5: Construir y subir la imagen Docker.
    # âŒ MALA PRÃCTICA: No se escanea la imagen por vulnerabilidades antes de subirla.
    # âŒ MALA PRÃCTICA: Login a Docker Hub usando contraseÃ±a plana desde variable de entorno insegura.
    - name: Construir imagen Docker
      run: |
        docker build -t myinsecureapp:latest .
        echo $DOCKER_PASSWORD | docker login --username myuser --password-stdin
        docker push myinsecureapp:latest

    # ----------------------------------------------------------------------------------------
    # ğŸ“Œ Paso 6: Desplegar en servidor de producciÃ³n.
    # âŒ MALA PRÃCTICA: Despliegue directo sin pasos de revisiÃ³n ni aprobaciones manuales.
    # âŒ MALA PRÃCTICA: Uso de SSH con comandos directos sin hardening ni control de acceso robusto.
    - name: Desplegar en servidor de producciÃ³n
      run: |
        ssh user@prod-server 'docker pull myinsecureapp:latest && docker stop myinsecureapp && docker rm myinsecureapp && docker run -d --name myinsecureapp myinsecureapp:latest'